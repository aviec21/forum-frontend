<!DOCTYPE html>
<html>
<head>
    <title>Campus Forum</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background: #f0f2f5; }
        .container { max-width: 1000px; margin: 0 auto; display: flex; gap: 20px; padding: 20px; }
        .main-content { flex: 3; } 
        .sidebar { flex: 1; background: white; padding: 15px; border-radius: 8px; height: fit-content; position: sticky; top: 20px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #ddd; cursor: pointer; font-weight: bold; border-radius: 5px; }
        .tab-btn.active { background: #333; color: white; }

        .post { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .meta { color: #666; font-size: 0.8em; margin-bottom: 8px; }
        
        /* Updated Reply/Vote Styles */
        .reply-item { border-top: 1px solid #eee; padding: 8px 0; margin-top: 5px; font-size: 0.95em; }
        .reply-actions { display: flex; gap: 10px; margin-top: 4px; font-size: 0.8em; color: #555; }
        .vote-btn { background: none; border: none; cursor: pointer; color: #555; padding: 0; }
        .vote-btn:hover { color: blue; }

        .top-post-item { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 0.9em; cursor: pointer; display: block; text-decoration: none; color: #333;}
        
        /* Inputs & Buttons */
        input, textarea { width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .post-btn { background: #2563eb; color: white; border: none; padding: 6px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .load-more-btn { width: 100%; padding: 10px; background: #ddd; border: none; margin-top: 10px; cursor: pointer; font-weight: bold; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="login-page" style="max-width:400px; margin: 50px auto; background:white; padding:30px; border-radius:10px; text-align:center;">
        <h2>üîí Campus Login</h2>
        <input type="email" id="email" placeholder="student@iimidr.ac.in">
        <button class="post-btn" style="width:100%; margin-top:10px;" onclick="requestOtp()">Get Code</button>
        <div id="otp-section" class="hidden">
            <input type="text" id="otp" placeholder="Enter Code">
            <button class="post-btn" style="width:100%; margin-top:10px;" onclick="verifyOtp()">Enter Forum</button>
        </div>
    </div>

    <div id="main-page" class="hidden">
        <div class="container">
            
            <div class="main-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h2>üì¢ Campus Board</h2>
                    <input type="text" id="search-box" placeholder="Search topics..." style="width:200px; margin:0;" onkeydown="handleSearch(event)">
                </div>

                <div class="tabs">
                    <button id="btn-serious" class="tab-btn active" onclick="switchCategory('serious')">Serious üéì</button>
                    <button id="btn-bakwaas" class="tab-btn" onclick="switchCategory('bakwaas')">Bakwaas ü§™</button>
                </div>

                <div style="background:white; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <textarea id="new-post-content" rows="3" placeholder="Write something..."></textarea>
                    <div style="display:flex; justify-content: flex-end; margin-top:10px;">
                        <button class="post-btn" onclick="createPost()">Post</button>
                    </div>
                </div>

                <div id="posts-container"></div>
                <button id="load-more-btn" class="load-more-btn hidden" onclick="loadMore()">Load More</button>
            </div>

            <div class="sidebar">
                <h3>üî• Top 10 (By Replies)</h3>
                <div id="top-posts-list">Loading...</div>
                <button onclick="logout()" style="margin-top:20px; width:100%; background:red; color:white; border:none; padding:5px;">Logout</button>
            </div>

        </div>
    </div>

    <script>
        const API_URL = "https://your-worker-url.workers.dev/api"; // UPDATE THIS

        let token = localStorage.getItem("anon_token");
        let currentCategory = "serious";
        let currentOffset = 0;
        let currentSearch = "";

        // Check URL params
        const urlParams = new URLSearchParams(window.location.search);
        const singlePostId = urlParams.get('viewPost');

        if (token) {
            document.getElementById("login-page").classList.add("hidden");
            document.getElementById("main-page").classList.remove("hidden");
            if (singlePostId) {
                loadSinglePost(singlePostId);
            } else {
                initialLoad();
            }
            loadTop10();
        }

        function handleSearch(e) {
            if(e.key === 'Enter') {
                currentSearch = e.target.value;
                initialLoad(); // Reset list and search
            }
        }

        function switchCategory(cat) {
            currentCategory = cat;
            currentSearch = ""; // Clear search when switching tabs
            document.getElementById("search-box").value = "";
            document.getElementById("btn-serious").className = cat === 'serious' ? 'tab-btn active' : 'tab-btn';
            document.getElementById("btn-bakwaas").className = cat === 'bakwaas' ? 'tab-btn active' : 'tab-btn';
            
            if(singlePostId) window.location.href = window.location.pathname; 
            initialLoad();
            loadTop10();
        }

        // RESET and Load First 5
        function initialLoad() {
            currentOffset = 0;
            document.getElementById("posts-container").innerHTML = ""; // Clear old posts
            fetchPosts();
        }

        // Append Next 5
        function loadMore() {
            currentOffset += 5;
            fetchPosts();
        }

        async function fetchPosts() {
            let url = `${API_URL}/posts?offset=${currentOffset}`;
            
            if(currentSearch) {
                url += `&search=${encodeURIComponent(currentSearch)}`;
            } else {
                url += `&category=${currentCategory}`;
            }

            const res = await fetch(url);
            const posts = await res.json();
            renderPosts(posts);

            // Hide "Load More" if we got fewer than 5 posts (end of list)
            if(posts.length < 5) {
                document.getElementById("load-more-btn").classList.add("hidden");
            } else {
                document.getElementById("load-more-btn").classList.remove("hidden");
            }
        }

        async function loadSinglePost(id) {
            document.querySelector(".tabs").classList.add("hidden");
            document.getElementById("load-more-btn").classList.add("hidden");
            const res = await fetch(`${API_URL}/posts?id=${id}`);
            const posts = await res.json();
            renderPosts(posts);
        }

        function renderPosts(posts) {
            const container = document.getElementById("posts-container");
            const html = posts.map(post => `
                <div class="post">
                    <div class="meta">User ${post.random_user_id} ‚Ä¢ ${new Date(post.created_at * 1000).toLocaleDateString()}</div>
                    <div style="font-size:1.1em; margin-bottom:10px;">${post.content}</div>
                    
                    <div style="background:#f9f9f9; padding:10px; border-radius:5px;">
                        ${post.replies ? post.replies.map(r => `
                            <div class="reply-item">
                                <strong>User ${r.random_user_id}:</strong> ${r.content}
                                <div class="reply-actions">
                                    <button class="vote-btn" onclick="vote(${r.id}, 'like')">üëç ${r.likes || 0}</button>
                                    <button class="vote-btn" onclick="vote(${r.id}, 'dislike')">üëé ${r.dislikes || 0}</button>
                                </div>
                            </div>
                        `).join('') : ''}
                        
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <input type="text" id="reply-input-${post.id}" placeholder="Add reply..." style="margin:0; background:white;">
                            <button onclick="reply(${post.id})" style="width:80px; margin:0; background:#555; color:white; border:none;">Reply</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Append to existing list
            container.insertAdjacentHTML('beforeend', html);
        }

        async function vote(replyId, type) {
            await fetch(`${API_URL}/vote`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ replyId, type })
            });
            // We don't reload everything to keep scroll position, just alert or let it be
        }

        async function loadTop10() {
            const res = await fetch(`${API_URL}/top-posts?category=${currentCategory}`);
            const posts = await res.json();
            document.getElementById("top-posts-list").innerHTML = posts.map((post, index) => `
                <a href="?viewPost=${post.id}" target="_blank" class="top-post-item">
                    <strong>#${index + 1}</strong> ${post.content} <span style="font-size:0.8em; color:#888;">(Score: ${post.score})</span>
                </a>
            `).join('');
        }

        async function createPost() {
            const content = document.getElementById("new-post-content").value;
            if(!content) return;
            await fetch(`${API_URL}/posts`, {
                method: "POST",
                headers: { "Authorization": token, "Content-Type": "application/json" },
                body: JSON.stringify({ content, category: currentCategory })
            });
            document.getElementById("new-post-content").value = "";
            initialLoad();
            loadTop10();
        }

        async function reply(postId) {
            const content = document.getElementById(`reply-input-${postId}`).value;
            if(!content) return;
            await fetch(`${API_URL}/reply`, {
                method: "POST",
                headers: { "Authorization": token, "Content-Type": "application/json" },
                body: JSON.stringify({ postId, content })
            });
            // Reload strictly this post or just refresh
            initialLoad(); 
        }

        // --- AUTH ---
        async function requestOtp() {
            const email = document.getElementById("email").value;
            const res = await fetch(`${API_URL}/login`, { method: "POST", body: JSON.stringify({ email }) });
            if(res.ok) { document.getElementById("otp-section").classList.remove("hidden"); } 
            else { alert("Invalid Domain"); }
        }
        async function verifyOtp() {
            const email = document.getElementById("email").value;
            const otp = document.getElementById("otp").value;
            const res = await fetch(`${API_URL}/verify`, { method: "POST", body: JSON.stringify({ email, otp }) });
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem("anon_token", data.token);
                location.reload(); 
            } else { alert("Invalid Code"); }
        }
        function logout() { localStorage.removeItem("anon_token"); location.reload(); }
    </script>
</body>
</html>
