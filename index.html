<!DOCTYPE html>
<html>
<head>
    <title>Campus Forum</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background: #f0f2f5; }
        
        /* HEADER (Modified for Tabs) */
        .header { background: white; padding: 10px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; height: 50px; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo { font-size: 1.2em; font-weight: bold; color: #333; margin-right: 10px; }
        
        /* TABS (Now inside Header) */
        .nav-tabs { display: flex; gap: 5px; background: #f0f2f5; padding: 4px; border-radius: 6px; }
        .nav-btn { border: none; background: none; padding: 6px 15px; cursor: pointer; font-weight: bold; font-size: 0.9em; border-radius: 4px; color: #666; }
        .nav-btn.active { background: #fff; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .nav-btn:hover { color: #000; }

        .logout-btn { background: #fee2e2; color: #dc2626; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold; }

        .container { max-width: 1000px; margin: 20px auto; display: flex; gap: 20px; padding: 0 20px; }
        .main-content { flex: 3; } 
        .sidebar { flex: 1; background: white; padding: 15px; border-radius: 8px; height: fit-content; position: sticky; top: 80px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-width: 0 }
        
        /* SEARCH & INPUTS */
        .search-container { display: flex; gap: 5px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; height: 40px; box-sizing: border-box; }
        .search-btn { width: 50px; height: 40px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; }

        /* POSTS & TEXT WRAPPING FIX */
        .post { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .post-content { 
            font-size: 1.1em; 
            margin-bottom: 10px; 
            color: #1f2937;
            white-space: pre-wrap; /* Preserves new lines */
            overflow-wrap: anywhere; /* FIX: Breaks long words like fffffff */
            word-break: break-word; 
        }
        .meta { color: #888; font-size: 0.8em; margin-bottom: 8px; }
        
        /* REPLY & VOTE */
        .reply-section { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .reply-item { border-top: 1px solid #eee; padding: 8px 0; font-size: 0.9em; overflow-wrap: anywhere; }
        .vote-row { display: flex; gap: 15px; margin-top: 5px; }
        
        .vote-btn { background: none; border: none; cursor: pointer; color: #888; font-size: 0.85em; padding: 0; transition: color 0.2s; }
        .vote-btn:hover { color: #555; }
        .vote-btn.voted-like { color: #2563eb; font-weight: bold; } /* Blue for Like */
        .vote-btn.voted-dislike { color: #dc2626; font-weight: bold; } /* Red for Dislike */

        /* UTILS */
        textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; font-family: inherit; }
        .post-btn { background: #2563eb; color: white; border: none; padding: 6px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .post-btn:hover { background: #1d4ed8; }
        .load-more-btn { width: 100%; padding: 10px; background: #e5e7eb; border: none; margin-top: 10px; cursor: pointer; font-weight: bold; border-radius: 4px; color: #374151; }
        .hidden { display: none !important; }

        /* SIDEBAR ITEMS (Add this missing block!) */
        .top-post-item { 
            display: block; padding: 8px 0; border-bottom: 1px solid #eee; color: #333; text-decoration: none; font-size: 0.9em; 
            
            /* These lines cut off long text nicely with "..." */
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .top-post-item:hover { color: #2563eb; }

        /* RESPONSIVE LAYOUT (Mobile Optimization) */
        @media (max-width: 768px) {
            .container {
                flex-direction: column; /* Stack items vertically */
                padding: 10px;          /* Less padding on small screens */
            }

            .main-content {
                order: 1; /* Feed comes FIRST */
                width: 100%;
            }

            .sidebar {
                order: 2; /* Sidebar moves to the BOTTOM */
                width: 100%;
                margin-top: 30px; /* Add spacing so it doesn't touch the last post */
                position: static; /* Remove sticky on mobile so it sits naturally at the bottom */
                box-shadow: none; /* Optional: Cleaner look on mobile */
                border-top: 1px solid var(--border-color); /* Add a divider line */
                padding-top: 20px;
            }
            
            /* Adjust Header for mobile */
            .header {
                padding: 10px; /* Tighter header */
            }
            .logo {
                font-size: 1em; /* Slightly smaller logo text */
            }
            .nav-btn {
                padding: 5px 10px; /* Smaller tabs */
            }
        }

        
    </style>
</head>
<body>

    <div id="login-page" style="max-width:400px; margin: 100px auto; background:white; padding:30px; border-radius:10px; text-align:center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
        <h2>üîí Campus Login</h2>
        <input type="email" id="email" placeholder="student@iimidr.ac.in" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
        <button class="post-btn" style="width:100%;" onclick="requestOtp()">Get Code</button>
        <div id="otp-section" class="hidden" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <input type="text" id="otp" placeholder="Enter 6-digit Code" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
            <button class="post-btn" style="width:100%;" onclick="verifyOtp()">Enter Forum</button>
        </div>
    </div>

    <div id="main-page" class="hidden">
        
        <div class="header">
            <div class="header-left">
                <div class="logo">üì¢ Campus Board</div>
                <div class="nav-tabs" id="header-tabs">
                    <button id="btn-serious" class="nav-btn active" onclick="switchCategory('serious')">Serious üéì</button>
                    <button id="btn-bakwaas" class="nav-btn" onclick="switchCategory('bakwaas')">Bakwaas ü§™</button>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <div class="main-content">
                
                <div class="search-container">
                    <input type="text" id="search-box" class="search-input" placeholder="Search topics..." onkeydown="handleEnter(event, triggerSearch)">
                    <button class="search-btn" onclick="triggerSearch()">üîç</button>
                </div>

                <div id="create-post-container" style="background:white; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <textarea id="new-post-content" rows="3" placeholder="Write something anonymous... (Press Enter to post)" onkeydown="handleEnter(event, createPost)"></textarea>
                    <div style="display:flex; justify-content: flex-end; margin-top:10px;">
                        <button class="post-btn" onclick="createPost()">Post</button>
                    </div>
                </div>

                <div id="posts-container"></div>
                <button id="load-more-btn" class="load-more-btn hidden" onclick="loadMore()">Load More posts...</button>
            </div>

            <div class="sidebar">
                <h3 style="margin-top:0;">üî• Top 10</h3>
                <div id="top-posts-list">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // *** UPDATE YOUR WORKER URL HERE ***
        const API_URL = "https://dry-haze-494a.agiri2016.workers.dev/api"; 

        let token = localStorage.getItem("anon_token");
        let currentCategory = "serious";
        let currentOffset = 0;
        let currentSearch = "";

        const urlParams = new URLSearchParams(window.location.search);
        const singlePostId = urlParams.get('viewPost');

        if (token) {
            document.getElementById("login-page").classList.add("hidden");
            document.getElementById("main-page").classList.remove("hidden");
            if (singlePostId) {
                loadSinglePost(singlePostId);
            } else {
                initialLoad();
            }
            loadTop10();
        }

        // --- ENTER KEY HANDLER ---
        function handleEnter(e, callback, param) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Stop new line
                callback(param); // Submit
            }
        }

        function switchCategory(cat) {
            currentCategory = cat;
            currentSearch = ""; 
            document.getElementById("search-box").value = "";
            document.getElementById("btn-serious").className = cat === 'serious' ? 'nav-btn active' : 'nav-btn';
            document.getElementById("btn-bakwaas").className = cat === 'bakwaas' ? 'nav-btn active' : 'nav-btn';
            
            if(singlePostId) window.location.href = window.location.pathname; 
            initialLoad();
            loadTop10();
        }

        function initialLoad() {
            currentOffset = 0;
            document.getElementById("posts-container").innerHTML = ""; 
            fetchPosts();
        }

        function loadMore() {
            currentOffset += 5;
            fetchPosts();
        }

        async function fetchPosts() {
            let url = `${API_URL}/posts?offset=${currentOffset}`;
            if(currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;
            else url += `&category=${currentCategory}`;

            try {
                const res = await fetch(url);
                const posts = await res.json();
                renderPosts(posts);
                const btn = document.getElementById("load-more-btn");
                if(posts.length < 5) btn.classList.add("hidden");
                else btn.classList.remove("hidden");
            } catch (e) { console.error(e); }
        }

        async function loadSinglePost(id) {
            // HIDE ELEMENTS FOR SINGLE VIEW
            document.getElementById("header-tabs").classList.add("hidden"); // Hide tabs in header
            document.querySelector(".search-container").classList.add("hidden");
            document.getElementById("load-more-btn").classList.add("hidden");
            document.getElementById("create-post-container").classList.add("hidden"); // Hide Post Box

            const res = await fetch(`${API_URL}/posts?id=${id}`);
            const posts = await res.json();
            renderPosts(posts);
        }

        function renderPosts(posts) {
            const container = document.getElementById("posts-container");
            if (posts.length === 0 && currentOffset === 0) {
                container.innerHTML = "<div style='text-align:center; padding:20px; color:#888;'>No posts found.</div>";
                return;
            }

            const html = posts.map(post => `
                <div class="post">
                    <div class="meta">User ${post.random_user_id} ‚Ä¢ ${new Date(post.created_at * 1000).toLocaleDateString()}</div>
                    <div class="post-content">${post.content}</div>
                    
                    <div class="reply-section">
                        <div id="reply-list-${post.id}">
                            ${post.replies && post.replies.length > 0 ? post.replies.map(r => `
                                <div class="reply-item">
                                    <span style="font-weight:bold; color:#4b5563;">User ${r.random_user_id}:</span> ${r.content}
                                    <div class="vote-row">
                                        <button id="like-btn-${r.id}" class="vote-btn" onclick="vote(${r.id}, 'like')">üëç ${r.likes || 0}</button>
                                        <button id="dislike-btn-${r.id}" class="vote-btn" onclick="vote(${r.id}, 'dislike')">üëé ${r.dislikes || 0}</button>
                                    </div>
                                </div>
                            `).join('') : ''} </div>
                        
                        <div style="display:flex; gap:8px; margin-top:15px;">
                            <textarea id="reply-input-${post.id}" rows="1" placeholder="Reply... (Enter to submit)" 
                                      style="padding:8px; border:1px solid #ddd; border-radius:4px; flex:1;"
                                      onkeydown="handleEnter(event, reply, ${post.id})"></textarea>
                            <button onclick="reply(${post.id})" style="background:#555; color:white; border:none; padding:5px 15px; border-radius:4px; cursor:pointer;">Reply</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.insertAdjacentHTML('beforeend', html);
        }

        async function loadTop10() {
            const list = document.getElementById("top-posts-list");
            
            try {
                const res = await fetch(`${API_URL}/top-posts?category=${currentCategory}`);
                
                // Safety check for server errors
                if (!res.ok) throw new Error("Server Error");
                
                const posts = await res.json();

                // Handle empty list
                if (!posts || posts.length === 0) {
                    list.innerHTML = "<div style='color:#999; padding:10px 0; font-size:0.9em;'>No active posts.</div>";
                    return;
                }

                // RENDER LIST (Clean vertical list, NO scores)
                list.innerHTML = posts.map((post, index) => `
                    <a href="?viewPost=${post.id}" target="_blank" class="top-post-item">
                        <strong>#${index + 1}</strong> ${post.content}
                    </a>
                `).join('');
                
            } catch (e) {
                console.error(e);
                list.innerHTML = "<div style='color:red; font-size:0.8em;'>Failed to load.</div>";
            }
        }
        
        
        async function vote(replyId, type) {
            const btnId = type === 'like' ? `like-btn-${replyId}` : `dislike-btn-${replyId}`;
            const otherBtnId = type === 'like' ? `dislike-btn-${replyId}` : `like-btn-${replyId}`;
            const btn = document.getElementById(btnId);
            const otherBtn = document.getElementById(otherBtnId);
            
            // 1. Send Request
            const res = await fetch(`${API_URL}/vote`, {
                method: "POST",
                headers: { "Authorization": token, "Content-Type": "application/json" },
                body: JSON.stringify({ replyId, type })
            });

            const text = await res.text();

            // 2. Handle UI based on Server Response
            // Helper to get number: "üëç 5" -> 5
            const getNum = (el) => parseInt(el.innerText.split(" ")[1]) || 0;
            const setNum = (el, icon, num) => el.innerText = `${icon} ${num}`;

            if (text === "Voted") {
                // Add 1 to clicked
                setNum(btn, type==='like'?'üëç':'üëé', getNum(btn) + 1);
                btn.classList.add(type === 'like' ? 'voted-like' : 'voted-dislike');
            } 
            else if (text === "Removed") {
                // Remove 1 from clicked
                setNum(btn, type==='like'?'üëç':'üëé', Math.max(0, getNum(btn) - 1));
                btn.classList.remove('voted-like', 'voted-dislike');
            } 
            else if (text === "Switched") {
                // Remove 1 from OTHER, Add 1 to THIS
                setNum(otherBtn, type==='like'?'üëé':'üëç', Math.max(0, getNum(otherBtn) - 1));
                otherBtn.classList.remove('voted-like', 'voted-dislike');

                setNum(btn, type==='like'?'üëç':'üëé', getNum(btn) + 1);
                btn.classList.add(type === 'like' ? 'voted-like' : 'voted-dislike');
            }
        }

        async function createPost() {
            const content = document.getElementById("new-post-content").value;
            if(!content.trim()) return;
            
            await fetch(`${API_URL}/posts`, {
                method: "POST",
                headers: { "Authorization": token, "Content-Type": "application/json" },
                body: JSON.stringify({ content, category: currentCategory })
            });
            document.getElementById("new-post-content").value = "";
            initialLoad();
            loadTop10();
        }

        async function reply(postId) {
            const input = document.getElementById(`reply-input-${postId}`);
            const content = input.value;
            if(!content.trim()) return;

            // 1. Disable input briefly so user doesn't double-click
            input.disabled = true;

            // 2. Send to Server & Wait for the new ID
            const res = await fetch(`${API_URL}/reply`, {
                method: "POST",
                headers: { "Authorization": token, "Content-Type": "application/json" },
                body: JSON.stringify({ postId, content })
            });
            
            const data = await res.json(); // Server returns: { id: 123 }

            // 3. Append HTML (Now with the REAL ID for buttons!)
            const replyList = document.getElementById(`reply-list-${postId}`);
            const myUserId = token || "Me"; 

            const newHTML = `
                <div class="reply-item" style="background-color:#f0fdf4;">
                    <span style="font-weight:bold; color:#4b5563;">User ${myUserId}:</span> ${content}
                    <div class="vote-row">
                        <button id="like-btn-${data.id}" class="vote-btn" onclick="vote(${data.id}, 'like')">üëç 0</button>
                        <button id="dislike-btn-${data.id}" class="vote-btn" onclick="vote(${data.id}, 'dislike')">üëé 0</button>
                    </div>
                </div>
            `;
            
            replyList.insertAdjacentHTML('beforeend', newHTML);
            
            // 4. Reset Input
            input.value = "";
            input.disabled = false;
            input.focus();
        }

        // --- AUTH ---
        async function requestOtp() {
            const email = document.getElementById("email").value;
            if(!email) return alert("Please enter email");
            const res = await fetch(`${API_URL}/login`, { method: "POST", body: JSON.stringify({ email }) });
            if(res.ok) document.getElementById("otp-section").classList.remove("hidden");
            else alert("Error");
        }
        async function verifyOtp() {
            const email = document.getElementById("email").value;
            const otp = document.getElementById("otp").value;
            const res = await fetch(`${API_URL}/verify`, { method: "POST", body: JSON.stringify({ email, otp }) });
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem("anon_token", data.token);
                location.reload(); 
            } else { alert("Incorrect OTP"); }
        }
        function logout() { localStorage.removeItem("anon_token"); location.reload(); }
    </script>
</body>
</html>
